<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebGL 原型试玩</title>
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Noto Sans CJK SC, Helvetica, Arial, sans-serif;
      background:#0b0f14;
      color:#e7eef7;
    }
    .wrap{ max-width: 900px; margin: 0 auto; padding: 28px 16px 48px; }
    .card{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(8px);
    }
    h1{ font-size: 22px; margin: 0 0 12px; }
    .sub{ opacity: .85; margin: 0 0 16px; line-height: 1.5; }
    .pill{
      display:inline-block;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
    }
    .cta{
      display:block; width:100%;
      border:0; border-radius:14px;
      padding:16px 18px;
      font-size:18px; font-weight:700;
      cursor:pointer;
      background:#3b82f6; color:white;
    }
    .cta:active{ transform: translateY(1px); }

    .row{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:14px; }
    @media (min-width: 760px){ .row{ grid-template-columns: 1fr 1fr; } }
    .box{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px;
    }
    .box h2{ font-size:14px; margin:0 0 10px; opacity:.9; }
    ul{ margin:0; padding-left:18px; line-height:1.65; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color:#e7eef7;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); }
    .muted{ opacity:.75; font-size:12px; line-height:1.6; }
    .divider{ height: 14px; }

    /* Unity 区域 */
    #unity-section{ display:none; margin-top: 18px; }
    #unity-container{
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background:#000;
      width:100%;
      position:relative;
      aspect-ratio: 16 / 9;
    }
    #unity-canvas{
      width:100%;
      height:100%;
      display:block;
      background:#000;
    }
    #loading-overlay{
      position:absolute; inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      background: rgba(0,0,0,0.55);
    }
    #progress{
      width:min(520px, 86%);
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      overflow:hidden;
      background: rgba(255,255,255,0.08);
    }
    #bar{
      height:100%;
      width:0%;
      background:#3b82f6;
    }
    #loading-text{ font-size:12px; opacity:.85; }
    #error-box{
      display:none;
      margin-top:10px;
      border:1px solid rgba(255,80,80,0.35);
      background: rgba(255,80,80,0.08);
      border-radius:12px;
      padding:12px;
      color:#ffd7d7;
    }
    code{ background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <h1>WebGL 原型试玩</h1>
        <span class="pill" id="version">v0.0.2</span>
      </div>

      <p class="sub">
        <b>请用 PC Chrome</b>（Windows / macOS）。部分浏览器可能加载失败或卡顿。
      </p>

      <button class="cta" id="btnStart">开始试玩</button>

      <div class="row">
        <div class="box">
          <h2>操作说明</h2>
          <ul>
            <li>数字1-5：出牌</li>
            <li>R：弃掉所有牌</li>
            <li>点击前进后退按钮：改变距离</li>
          </ul>
        </div>

        <div class="box">
          <h2>已知问题</h2>
          <ul>
            <li>首次加载可能较慢（取决于网络与缓存）</li>
            <li>毫无数值平衡</li>
            <li>没有手机端适配</li>
          </ul>
        </div>

        <div class="box">
          <h2>反馈入口</h2>
          <div class="btns">
            <a class="btn" href="https://example.com/your-form" target="_blank" rel="noopener">填写问卷</a>
            <a class="btn" href="mailto:your@email.com">发送邮件</a>
          </div>
        </div>

        <div class="box">
          <h2>加载慢/打不开怎么办</h2>
          <ul>
            <li>如加载失败：<b>刷新一次</b>（Ctrl+R）</li>
            <li>如仍失败：<b>清缓存</b>（Chrome → 设置 → 隐私与安全 → 清除浏览数据）</li>
          </ul>
          <div class="muted" style="margin-top:10px;">
            也可以尝试：关闭广告拦截/代理、换网络、用无痕模式打开。
          </div>
        </div>
      </div>

      <!-- Unity 加载区 -->
      <div id="unity-section">
        <div class="divider"></div>

        <div class="box">
          <h2>游戏加载区</h2>
          <div class="muted">
            首次加载会下载 <code>.data</code> / <code>.wasm</code>，请耐心等待。
          </div>
        </div>

        <div class="divider"></div>

        <div id="unity-container">
          <canvas id="unity-canvas" tabindex="-1"></canvas>

          <div id="loading-overlay">
            <div id="progress"><div id="bar"></div></div>
            <div id="loading-text">准备加载...</div>
            <div class="muted">建议使用 PC Chrome；如卡住请刷新一次</div>
          </div>
        </div>

        <div id="error-box"></div>

        <div class="btns" style="margin-top:12px;">
          <button class="btn" id="btnReload" type="button">刷新页面</button>
          <button class="btn" id="btnFullscreen" type="button">全屏</button>
        </div>
      </div>

      <div class="divider"></div>
    </div>
  </div>

  <script>
    // =========================
    // ✅ 你只需要改这里
    // =========================
    const VERSION = "v0.0.2";
    const BUILD_FOLDER = "./0.2/Build";
    const BUILD_NAME = "0.2"; // ← 改成你的导出前缀（例如 MyGame）
    const STREAMING_ASSETS_FOLDER = "./0.2/StreamingAssets";
    // =========================

    document.getElementById("version").textContent = VERSION;

    const unitySection = document.getElementById("unity-section");
    const canvas = document.getElementById("unity-canvas");
    const loadingOverlay = document.getElementById("loading-overlay");
    const bar = document.getElementById("bar");
    const loadingText = document.getElementById("loading-text");
    const errorBox = document.getElementById("error-box");

    // 给网页其它地方调用（网页 -> Unity）
    window.unityInstance = null;

    function showUnitySection() {
      unitySection.style.display = "block";
      unitySection.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function showError(message) {
      errorBox.style.display = "block";
      errorBox.innerHTML = `
        <b>加载失败</b><br/>
        <div style="margin-top:6px; opacity:.9;">${String(message).replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>
        <div class="muted" style="margin-top:8px;">
          常见原因：文件路径不对 / 服务器未正确配置 gzip/brotli / 缓存或跨域问题。<br/>
          先试：刷新一次 / 清缓存 / 用 PC Chrome。<br/>
          你也可以打开开发者工具 Console 看报错。
        </div>
      `;
      loadingOverlay.style.display = "none";
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load script: " + src));
        document.body.appendChild(s);
      });
    }

    async function startUnity() {
      // 防止重复加载
      if (window.unityInstance) return;

      loadingOverlay.style.display = "flex";
      bar.style.width = "0%";
      loadingText.textContent = "加载引导脚本...";

      const buildUrl = BUILD_FOLDER;
      const loaderUrl = `${buildUrl}/${BUILD_NAME}.loader.js`;

      const config = {
        dataUrl: `${buildUrl}/${BUILD_NAME}.data`,
        frameworkUrl: `${buildUrl}/${BUILD_NAME}.framework.js`,
        codeUrl: `${buildUrl}/${BUILD_NAME}.wasm`,
        streamingAssetsUrl: "StreamingAssets",
        companyName: "YourCompany",
        productName: "YourPrototype",
        productVersion: VERSION
      };

      try {
        await loadScript(loaderUrl);

        if (!window.createUnityInstance) {
          throw new Error("createUnityInstance not found. 请确认 loader.js 正确且未被拦截。");
        }

        loadingText.textContent = "下载资源中（首次较慢）...";

        const instance = await window.createUnityInstance(canvas, config, (progress) => {
          const p = Math.max(0, Math.min(1, progress || 0));
          bar.style.width = Math.round(p * 100) + "%";
          loadingText.textContent = `加载中... ${Math.round(p * 100)}%`;
        });

        window.unityInstance = instance;
        loadingOverlay.style.display = "none";
      } catch (e) {
        showError(e && e.message ? e.message : e);
      }
    }

    // 网页 -> Unity 调用助手
    function callUnity(gameObject, method, param = "") {
      const inst = window.unityInstance;
      if (!inst) {
        console.warn("Unity is not ready yet");
        return false;
      }
      inst.SendMessage(gameObject, method, String(param));
      return true;
    }

    // UI 事件
    document.getElementById("btnStart").addEventListener("click", async () => {
      showUnitySection();
      await startUnity();
    });

    document.getElementById("btnReload").addEventListener("click", () => {
      location.reload();
    });

    document.getElementById("btnFullscreen").addEventListener("click", () => {
      if (window.unityInstance) window.unityInstance.SetFullscreen(1);
      else alert("Unity 还没加载完成。");
    });

    document.getElementById("btnPingUnity").addEventListener("click", () => {
      // 你 Unity 里需要：
      // 场景中一个名叫 WebBridge 的 GameObject
      // 挂脚本：public void RestartRun(string _) { ... }
      const ok = callUnity("WebBridge", "RestartRun", "");
      if (!ok) alert("Unity 还没加载完成。");
    });
  </script>
</body>
</html>